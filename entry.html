<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Daily Production Entry</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />

  <style>
    :root {
      --bg-color: #1C1B2F;
      --card-bg: #2A2938;
      --input-bg: #3A3948;
      --text-color: #ECECEC;
      --accent: #6C63FF;
    }
    body {
      background-color: var(--bg-color);
      color: var(--text-color);
    }
    .form-control, .form-select, textarea {
      background-color: var(--input-bg) !important;
      color: var(--text-color) !important;
      border: none;
    }
    .form-control:focus, .form-select:focus {
      box-shadow: 0 0 0 0.2rem rgba(108, 99, 255, 0.25);
    }
    .toggle-switch {
      position: absolute;
      top: 1rem;
      right: 1rem;
      display: flex;
      align-items: center;
    }
    .toggle-switch input {
      margin-left: 0.5rem;
      transform: scale(1.2);
    }
    .card.bg-success {
      background-color: #198754 !important;
    }
    .card.bg-warning {
      background-color: #ffc107 !important;
    }
    @media (max-width: 576px) {
      .toggle-switch {
        top: 0.5rem;
        right: 0.5rem;
      }
    }
    #materialShortageMsg {
      color: #dc3545;
      font-weight: 600;
      margin-top: 0.25rem;
    }
  </style>
</head>

<body class="bg-dark text-light position-relative">
  <div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2>Production Entry</h2>
      <div class="toggle-switch">
        Dark Mode
        <input id="modeToggle" type="checkbox" checked />
      </div>
    </div>

    <form id="entryForm" class="needs-validation" novalidate>
      <div class="row g-3">
        <div class="col-md-6">
          <label for="orderNo" class="form-label">Order No</label>
          <select id="orderNo" name="orderNo" class="form-select" required></select>
        </div>
        <div class="col-md-6">
          <label for="brand" class="form-label">Brand</label>
          <select id="brand" name="brand" class="form-select" required></select>
        </div>
        <div class="col-md-6">
          <label for="productType" class="form-label">Product Type</label>
          <select id="productType" name="productType" class="form-select" required>
            <option value="">-- Select Type --</option>
            <option value="Tag">Tag</option>
            <option value="Sticker">Sticker</option>
          </select>
        </div>
        <div class="col-md-6">
          <label for="OrderQty" class="form-label">Order Qty</label>
          <select id="OrderQty" name="OrderQtyId" class="form-select" required></select>
        </div>
        <div class="col-md-12">
          <label for="itemName" class="form-label">Item Name</label>
          <select id="itemName" name="itemNameId" class="form-select" required></select>
        </div>
        <div class="col-md-6">
          <label for="machine" class="form-label">Machine Used</label>
          <select id="machine" name="machineId" class="form-select" required></select>
        </div>
        <div class="col-md-6">
          <label for="operator" class="form-label">Operator</label>
          <select id="operator" name="operatorId" class="form-select" required></select>
        </div>
        <div class="col-md-6">
          <label for="shift" class="form-label">Shift</label>
          <select id="shift" name="shift" class="form-select" required>
            <option value="">-- Select Shift --</option>
            <option value="1st Shift">1st Shift</option>
            <option value="2nd Shift">2nd Shift</option>
            <option value="3rd Shift">3rd Shift</option>
          </select>
        </div>
        <div class="col-md-6">
          <label for="entryDate" class="form-label">Entry Date</label>
          <input type="date" id="entryDate" name="entryDate" class="form-control" required>
        </div>
        <div class="col-md-6">
          <label for="shippingDate" class="form-label">Agreed Shipping Date</label>
          <input type="date" id="shippingDate" name="shippingDate" class="form-control" readonly>
        </div>
        <div class="col-md-6">
          <label for="productionCompletedDate" class="form-label">Production Completed Date</label>
          <input type="date" id="productionCompletedDate" name="productionCompletedDate" class="form-control">
        </div>
        <div class="col-md-4">
          <label for="materialPicked" class="form-label">Material Picked</label>
          <input type="number" id="materialPicked" name="materialPicked" class="form-control" required readonly>
        </div>
        <div class="col-md-4">
          <label for="produced" class="form-label">Produced</label>
          <input type="number" id="produced" name="produced" class="form-control" required min="0">
        </div>
        <div class="col-md-4">
          <label for="wasted" class="form-label">Wasted</label>
          <input type="number" id="wasted" name="wasted" class="form-control" min="0">
        </div>
        <div class="col-md-4">
          <label for="remainingMaterial" class="form-label">Remaining Material</label>
          <input type="number" id="remainingMaterial" class="form-control" readonly>
        </div>
        <div class="col-md-8 d-flex align-items-end">
          <div id="materialShortageMsg" class="d-none">Material shortage detected!</div>
        </div>
        <div class="col-md-12">
          <label for="wastageReason" class="form-label">Wastage Reason</label>
          <select id="wastageReason" name="wastageReason" class="form-select">
            <option value="">-- Select Reason --</option>
            <option value="Defect">Defect</option>
            <option value="Setup Error">Setup Error</option>
            <option value="Material Issue">Material Issue</option>
          </select>
        </div>
        <div class="col-md-6">
          <label for="status" class="form-label">Status</label>
          <select id="status" name="status" class="form-select" required>
            <option value="Selected">Selected</option>
            <option value="Under Production">Under Production</option>
            <option value="Completed">Completed</option>
          </select>
        </div>
      </div>
      <button type="submit" class="btn btn-success w-100 mt-4">Submit Entry</button>
    </form>

    <!-- preview, summary, history sections -->
    <div id="previewBox" class="mt-4">
      <h4>Entry Preview</h4>
      <div id="entryPreview" class="border rounded p-3 bg-white shadow-sm text-dark" style="max-height: 400px; overflow-y: auto;"></div>
      <div class="text-end mt-3">
        <button class="btn btn-primary" onclick="finalSave()">Final Save</button>
      </div>
    </div>

    <div class="mt-4">
      <h4>Summary Table</h4>
      <table class="table table-bordered table-sm text-light">
        <thead>
          <tr>
            <th>#</th><th>Date</th><th>Shift</th><th>Item</th><th>Brand</th>
            <th>Produced</th><th>Wasted</th><th>Waste %</th><th>Operator</th><th>Machine</th>
          </tr>
        </thead>
        <tbody id="summaryTableBody"></tbody>
      </table>
    </div>

    <hr class="my-4" />

    <div class="d-flex justify-content-between align-items-center mb-2">
      <h4>Today's Entries</h4>
      <div>
        <select id="filterOperator" class="form-select d-inline-block w-auto me-2">
          <option value="">All Operators</option>
        </select>
        <button class="btn btn-primary" onclick="exportCSV()">Export CSV</button>
      </div>
    </div>
    <div id="historyList" class="bg-white p-3 border rounded shadow-sm text-dark" style="max-height: 300px; overflow-y: auto;"></div>
  </div>

  <script>
    const sessionEntries = [];
    let ordersData = [];

    document.addEventListener('DOMContentLoaded', () => {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('entryDate').value = today;

      fetchAndPopulate();
      renderHistory();

      document.getElementById('modeToggle').addEventListener('change', e => {
        document.body.classList.toggle('light-mode', !e.target.checked);
        document.documentElement.setAttribute('data-bs-theme', e.target.checked ? 'dark' : 'light');
      });

      ['produced', 'wasted'].forEach(id => {
        document.getElementById(id).addEventListener('input', updateMaterialStatus);
      });
    });

    async function fetchAndPopulate() {
      const [orders, machines, operators] = await Promise.all([
        fetch('/api/orders').then(res => res.json()),
        fetch('/api/machines').then(res => res.json()),
        fetch('/api/operators').then(res => res.json())
      ]);
      ordersData = orders;

      const orderSelect = document.getElementById('orderNo');
      const brandSelect = document.getElementById('brand');
      const orderQtySelect = document.getElementById('OrderQty');
      const itemNameSelect = document.getElementById('itemName');
      const operatorFilter = document.getElementById('filterOperator');

      orderSelect.innerHTML = '';
      brandSelect.innerHTML = '';
      orderQtySelect.innerHTML = '';
      itemNameSelect.innerHTML = '';

      const brandsSet = new Set();

      orders.forEach(order => {
        const opt = new Option(order['Order No'], order['Order No']);
        opt.dataset.brand = order['Brand'] || '';
        opt.dataset.itemName = order['Item Name'] || '';
        opt.dataset.entryDate = order['Entry Date'] || '';
        opt.dataset.shippingDate = order['Agreed Shipping Date'] || order['Shipping Date'] || '';
        opt.dataset.orderQty = order['Order Qty'] || '';
        opt.dataset.materialPicked = order['Material Picked'] || '';

        orderSelect.appendChild(opt);
        brandsSet.add(order['Brand']);
      });

      brandsSet.forEach(b => brandSelect.appendChild(new Option(b, b)));

      orderSelect.addEventListener('change', () => {
        const sel = orderSelect.selectedOptions[0];
        if (!sel) return;
        brandSelect.value = sel.dataset.brand;
        itemNameSelect.innerHTML = '';
        itemNameSelect.appendChild(new Option(sel.dataset.itemName, sel.dataset.itemName));
        document.getElementById('entryDate').value = sel.dataset.entryDate || new Date().toISOString().split('T')[0];
        document.getElementById('shippingDate').value = sel.dataset.shippingDate || '';
        orderQtySelect.innerHTML = '';
        orderQtySelect.appendChild(new Option(sel.dataset.orderQty, sel.dataset.orderQty));
        document.getElementById('materialPicked').value = sel.dataset.materialPicked || '';
        updateMaterialStatus();
      });

      machines.forEach(m => {
        document.getElementById('machine').appendChild(new Option(m['Machine Name'], m['ID']));
      });
      operators.forEach(o => {
        document.getElementById('operator').appendChild(new Option(o['Operator Name'], o['ID']));
        operatorFilter.appendChild(new Option(o['Operator Name'], o['Operator Name']));
      });
      operatorFilter.addEventListener('change', renderHistory);
    }

    function updateMaterialStatus() {
      const mp = parseFloat(document.getElementById('materialPicked').value) || 0;
      const pr = parseFloat(document.getElementById('produced').value) || 0;
      const wa = parseFloat(document.getElementById('wasted').value) || 0;
      const rem = mp - pr - wa;
      document.getElementById('remainingMaterial').value = rem >= 0 ? rem : 0;

      const msg = document.getElementById('materialShortageMsg');
      if (pr + wa > mp) {
        msg.textContent = `Material shortage: exceed by ${ (pr + wa - mp).toFixed(2) }`;
        msg.classList.remove('d‑none');
      } else {
        msg.classList.add('d‑none');
      }
    }

    document.getElementById('entryForm').addEventListener('submit', e => {
      e.preventDefault();
      if (!e.target.checkValidity()) {
        e.target.classList.add('was‑validated');
        return;
      }
      // same submission logic...
      // [maintained as before]
      const data = new FormData(e.target);
      const payload = Object.fromEntries(data.entries());

      const entry = {
        date: payload.entryDate,
        machine: document.getElementById('machine').selectedOptions[0].textContent,
        machineId: payload.machineId,
        item: document.getElementById('itemName').value,
        brand: payload.brand,
        productType: payload.productType,
        produced: parseInt(payload.produced),
        wastage: parseInt(payload.wasted) || 0,
        wastePercent: payload.wasted && payload.produced
          ? ((payload.wasted / payload.produced) * 100).toFixed(2) + "%"
          : "0%",
        operators: document.getElementById('operator').selectedOptions[0].textContent,
        operatorId: payload.operatorId,
        remarks: payload.wastageReason || "",
        shift: payload.shift,
        completedDate: payload.productionCompletedDate || '',
        shippingDate: payload.shippingDate || ''
      };

      sessionEntries.push(entry);
      renderPreview();
      renderSummaryTable();
      e.target.reset();
      document.getElementById('entryDate').value = new Date().toISOString().split('T')[0];
      document.getElementById('shippingDate').value = '';
      document.getElementById('materialPicked').value = '';
      document.getElementById('remainingMaterial').value = '';
      e.target.classList.remove('was‑validated');
    });

    function renderPreview() {
      const container = document.getElementById('entryPreview');
      container.innerHTML = '';
      sessionEntries.forEach((entry, index) => {
        const card = document.createElement('div');
        card.className = `card mb‑2 shadow‑sm text‑dark ${entry.wastage > 0 ? 'bg‑warning' : 'bg‑success'}`;
        card.innerHTML = `
          <div class="card‑body">
            <h5 class="card‑title">${entry.item} <small class="text‑muted">(${entry.date})</small></h5>
            <p><strong>Brand:</strong> ${entry.brand} | <strong>Product Type:</strong> ${entry.productType}</p>
            <p><strong>Shift:</strong> ${entry.shift} | <strong>Completed Date:</strong> ${entry.completedDate || '-'} | <strong>Agreed Shipping Date:</strong> ${entry.shippingDate || '-'}</p>
            <p class="card‑text">
              <span class="badge bg‑primary me‑2">Machine: ${entry.machine}</span>
              <span class="badge bg‑info me‑2">Produced: ${entry.produced}</span>
              <span class="badge bg‑danger me‑2">Wasted: ${entry.wastage}</span>
              <span class="badge bg‑secondary">Waste %: ${entry.wastePercent}</span>
            </p>
            <p><strong>Operator:</strong> ${entry.operators} | <strong>Remarks:</strong> ${entry.remarks || '-'}</p>
            <button class="btn btn‑sm btn‑outline‑light me‑2" onclick="editEntry(${index})"><i class="bi bi‑pencil"></i> Edit</button>
            <button class="btn btn‑sm btn‑outline‑danger" onclick="deleteEntry(${index})"><i class="bi bi‑trash"></i> Delete</button>
          </div>`;
        container.appendChild(card);
      });
    }

    function renderSummaryTable() {
      const tbody = document.getElementById('summaryTableBody');
      tbody.innerHTML = '';
      sessionEntries.forEach((e, i) => {
        const wastePct = e.produced > 0 ? ((e.wastage / e.produced) * 100).toFixed(2) : "0.00";
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${i + 1}</td><td>${e.date || '-'}</td><td>${e.shift || '-'}</td>
          <td>${e.item || '-'}</td><td>${e.brand || '-'}</td>
          <td>${e.produced != null ? e.produced : '-'}</td><td>${e.wastage != null ? e.wastage : '-'}</td>
          <td>${wastePct}%</td><td>${e.operators || '-'}</td><td>${e.machine || '-'}</td>`;
        tbody.appendChild(row);
      });
    }

    function editEntry(idx) {
      const entry = sessionEntries[idx];
      if (!entry) return alert('Entry not found.');
      document.getElementById('entryDate').value = entry.date;
      document.getElementById('shift').value = entry.shift;
      document.getElementById('itemName').value = entry.item;
      document.getElementById('brand').value = entry.brand;
      document.getElementById('produced').value = entry.produced;
      document.getElementById('wasted').value = entry.wastage;
      document.getElementById('wastageReason').value = entry.remarks;
      document.getElementById('operator').value = entry.operatorId || '';
      document.getElementById('machine').value = entry.machineId || '';
      document.getElementById('productionCompletedDate').value = entry.completedDate || '';
      document.getElementById('shippingDate').value = entry.shippingDate || '';
      document.getElementById('productType').value = entry.productType;
      sessionEntries.splice(idx, 1);
      renderPreview();
      renderSummaryTable();
    }

    function deleteEntry(idx) {
      if (confirm('Are you sure you want to delete this entry?')) {
        sessionEntries.splice(idx, 1);
        renderPreview();
        renderSummaryTable();
      }
    }

    function renderHistory() {
      const container = document.getElementById('historyList');
      container.innerHTML = '';
      const filterOp = document.getElementById('filterOperator').value;
      const filtered = filterOp ? sessionEntries.filter(e => e.operators === filterOp) : sessionEntries;
      if (!filtered.length) {
        container.innerHTML = '<p>No entries found.</p>';
        return;
      }
      filtered.forEach(entry => {
        const div = document.createElement('div');
        div.className = 'mb‑2 border‑bottom pb‑2';
        div.innerHTML = `<strong>${entry.date} (${entry.shift})</strong><br/>
                          Item: ${entry.item} | Brand: ${entry.brand} | Produced: ${entry.produced} | Wasted: ${entry.wastage} (${entry.wastePercent})<br/>
                          Operator: ${entry.operators} | Machine: ${entry.machine}`;
        container.appendChild(div);
      });
    }

    function finalSave() {
  if (!sessionEntries.length) return alert('No entries to save.');
  localStorage.setItem('productionEntries', JSON.stringify(sessionEntries));
  alert('Entries saved successfully!');
  sessionEntries.length = 0;
  renderPreview();
  renderSummaryTable();
  renderHistory();
}


    function exportCSV() {
      if (!sessionEntries.length) return alert('No data to export.');
      const header = ['Date','Shift','Item','Brand','Produced','Wasted','Waste %','Operator','Machine'];
      const rows = sessionEntries.map(e => [
        e.date, e.shift, e.item, e.brand, e.produced, e.wastage,
        e.produced > 0 ? ((e.wastage/e.produced)*100).toFixed(2)+'%' : '0%', e.operators, e.machine
      ]);
      const csv = [header, ...rows]
        .map(r => r.map(cell => `"${cell}"`).join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url; link.download = 'production_entries.csv';
      link.style.display = 'none';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
  </script>
</body>
</html>
